# docker-vid-to-streamable

This project provides source code for creating a [docker](https://www.docker.com/) image that will monitor a directory for video files (recordings) and will for each recording it finds output a matching highly compressed, streamable video file to another directory (streams).

I made this because I was doing a project with a [Panasonic WV-SC385](http://www.panasonic.com/my/business/security-system/i-pro-smart-hd/dome-network-cameras/wv-sc385.html) camera, and found fthat although the camera outputs H.264 comressed video, the recordings were huge.  Apparently, the small processor in the camera does not try to compress the video very much, and the [moov atom](http://www.adobe.com/devnet/video/articles/mp4_movie_atom.html) was placed at the end of the captured recordings, which made streaming not work well.

The docker image generated by this docker file uses [ffmpeg](https://www.ffmpeg.org/) to recompress the video with the excellent [x264](http://www.videolan.org/developers/x264.html) codec and moves the [moov atom](http://www.adobe.com/devnet/video/articles/mp4_movie_atom.html) to the start of the file to improve streaming.  I found that the size of the files was reduced by a factor of ~4.5x using this system.

The python stream manager monitors the recordings directory `/mnt/rec` and outputs for each recording it finds a converted version to the streams directory `/mnt/stream`.  If the original recording is deleted, the stream manager will delete the corresponding stream as well.

## Recording file format

The stream manager expects to find streams in the following format:

```
<YYYY>-<MM>-<DD>_<hh><mm><ss><fff>.mp4

where

<YYYY> is a 4-digit year
<MM> is a 2-digit month
<DD> is a 2-digit day
<hh> is a 2-digit hour in 24-hour format
<mm> is a 2-digit minute
<ss> is a 2-digit second
<fff> is a 3-digit millisecond
```

For example, a valid name matching the pattern would be `2015-09-06_122837189.mp4`.
If your recordings have a different format, you need to adjust the matching code by customizing `rec.py`.

## Building the docker image

To build the image, run:

```bash
$ docker build .
```

## Getting the docker image from Docker Hub

If the default settings work for you, and you do not want to build the image yourself, you can conveniently get it from [Docker Hub](https://hub.docker.com/) by running:

```bash
$ docker pull xorbit/vid-to-streamable
```

## Using the docker image

To make this image useful, you need to provide volume parameters to map to the `/mnt/rec` and `mnt/stream` mountpoints in the container when you run it.  For example, if you execute:

```bash
$ docker run -d --restart=always -v /mnt/host/source/videos:/mnt/rec -v /mnt/host/destination/videos:/mnt/stream xorbit/vid-to-streamable
```

This will create a container that will keep running in the background and will monitor `/mnt/host/source/videos` for videos and maintain streamable versions in `/mnt/host/destination/videos`.
